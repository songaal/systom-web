<!DOCTYPE HTML>
<html lang="ko">
	<head>

		<title>트레이딩 차트</title>
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
		<meta charset="utf-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=Edge">

		<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet"/>
		<script src="//code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
		<script type="text/javascript" src="charting_library/charting_library.min.js"></script>
		<script type="text/javascript" src="datafeeds/udf/dist/polyfills.js"></script>
		<script type="text/javascript" src="datafeeds/udf/dist/bundle.js"></script>
		<script type="text/javascript">
			var registerDate = []
			var shapes = []
      function getParameterByName(name) {
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                  results = regex.exec(location.search);
          return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }
			TradingView.onready(function(){
				widget = window.tvWidget = new TradingView.widget({
					debug: false, // uncomment this line to see Library errors and warnings in the console
					fullscreen: true,
					symbol: 'BTC/USDT',
					interval: "D",
					timezone: "Asia/Seoul",
					container_id: "tv_chart_container",
					//	BEWARE: no trailing slash is expected in feed URL
					datafeed: new Datafeeds.UDFCompatibleDatafeed("https://9u3jawxuod.execute-api.ap-northeast-2.amazonaws.com/v1_1"),
					library_path: "charting_library/",
					locale: getParameterByName('lang') || "ko",
					// drawings_access: { type: 'black', tools: [ { name: "Regression Trend" } ] },
					// disabled_features: [""],
					// enabled_features: [""],
					charts_storage_url: 'http://saveload.tradingview.com',
                    charts_storage_api_version: "1.1",
					client_id: 'tradingview.com',
					user_id: 'public_user_id',
				});
				widget.onChartReady(function() {
					widget.onContextMenu(function(unixtime, price) {
						// console.log(unixtime, price)
						// 2018-06-30 23:00:00 format
						let tmp = new Date()
						tmp.setTime(unixtime * 1000)
						let timezoneOffset = tmp.getTime() + (tmp.getTimezoneOffset() * 60000)

						let date = new Date()
						date.setTime(timezoneOffset)
						let y = date.getFullYear()
						let m = (date.getMonth() + 1) >= 10 ? (date.getMonth() + 1) : '0' + (date.getMonth() + 1)
						let d = date.getDate() >= 10 ? date.getDate() : '0' + date.getDate()
						let h = date.getHours() >= 10 ? date.getHours() : '0' + date.getHours()
						let i = date.getMinutes() >= 10 ? date.getMinutes() : '0' + date.getMinutes()
						let s = date.getSeconds() >= 10 ? date.getSeconds() : '0' + date.getSeconds()
						var time = y + '-' + m + '-' + d + ' ' + h + ':' + i + ':' + s
		        return [{
		            position: "top",
		            text: "날짜 선택하기: " + time,
		            click: function() {
									registerDate.push(time)
									shapes.push(widget.chart()
				            .createExecutionShape()
				            .setTime(String(timezoneOffset).substring(0, 10))
				            .setText('선택됨')
				            .setDirection('선택됨'))
									changeView()
								}
		        }]
		    });
					// widget.createButton()
					// 	.attr('title', "Save chart")
					// 	.on('click', function (e) {
					// 		widget.save(function(data) {
					// 			savedWidgetContent = data;
					// 			alert('Saved');
					// 		})
					// 	 })
					// 	.append('<span>save</span>');
				})
			});

			function removeRegiserDate () {
				registerDate = []
				$(shapes).each(function(index, i){
					widget.chart().removeEntity(shapes[index]._line._id)
				})
				shapes = []
				changeView()
			}
			function removeIndex(index) {
				widget.chart().removeEntity(shapes[index]._line._id)
				shapes.splice(index, 1)
				registerDate.splice(index, 1)
				changeView()
			}

			function changeView() {
				let tag = []
				let txt = []
				$(registerDate).each(function(index, time) {
					let tmp = `
					<tr>
						<td>
							<span style="padding-top:15px;">${index + 1}</span>
						</td>
						<td>
							<span style="padding-top:15px;">${time}</span>
						</td>
						<td>
							<button class="btn-sm btn btn-link" style="margin-top: -5px;" onclick="removeIndex(${index})">해제</button>
						</td>
					</tr>
					`
					txt.push('"' + time + '"\n')
					tag.push(tmp)
				})
				$('#textArea').text(txt)
				$('#selectCount').text(registerDate.length)
				$('#dateCheckList').html(tag)
			}
			function clipboard () {
				let data = []
				$(registerDate).each(function(index, time){
					let tmp = '"'
					tmp += time
					tmp += '"'
					data.push(tmp)
				})
	      let t = document.createElement('textarea')
	      document.body.appendChild(t)
	      t.value = data.length > 0 ? data : ''
	      t.select()
	      let a = document.execCommand('copy')
	      document.body.removeChild(t)
	    }
		</script>
	</head>

	<body style="margin:0px;">
		<div class="row">
				<div class="col-md-9">
					<div id="tv_chart_container"></div>
				</div>
				<div class="col-md-3" style="padding:0px; margin-left:0px; margin-right:0px;">
					<div class="row">
						<div class="col-md-11">
							<div>
								<br />
								<p style="font-size:0.8em; " class="text-warning">
									차트에서 오른쪽 클릭 날짜 선택 메뉴 클릭
								</p>
							</div>
							<div>
								<br />
								선택한 날짜 (<span id="selectCount">0</span>)
							</div>
							<div>
								<br />
								<button class="btn btn-danger" onclick="removeRegiserDate()">초기화</button>
								<button class="btn btn-info" onclick="clipboard()">클립보드 복사</button>
							</div>
							<div>
								<br />
								<table class="table" id="dateCheckList"></table>
							</div>
							<div>
								<br />
								<span>결과</span>
								<textarea id="textArea" style="width:100%; height: 100px;"></textarea>
							</div>
						</div>
					</div>
				</div>
		</div>
	</body>

</html>
